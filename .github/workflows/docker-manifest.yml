name: Docker Multi-Arch Manifest

on:
  workflow_run:
    workflows: ["Docker Build AMD64", "Docker Build ARM64"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: cheolwanpark/claude-agent

jobs:
  create-manifest:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: read
    
    steps:
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Create and push multi-arch manifest
      run: |
        # Create manifest for latest tag
        docker manifest create ${{ env.IMAGE_NAME }}:latest \
          ${{ env.IMAGE_NAME }}:latest-amd64 \
          ${{ env.IMAGE_NAME }}:latest-arm64
        
        # Push the manifest
        docker manifest push ${{ env.IMAGE_NAME }}:latest
        
        # Create manifest for branch-specific tag if not main
        if [[ "${{ github.ref_name }}" != "main" ]]; then
          docker manifest create ${{ env.IMAGE_NAME }}:${{ github.ref_name }} \
            ${{ env.IMAGE_NAME }}:${{ github.ref_name }}-amd64 \
            ${{ env.IMAGE_NAME }}:${{ github.ref_name }}-arm64
          
          docker manifest push ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
        fi